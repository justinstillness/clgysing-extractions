================================================================================
FILE BROWSER — TOOL REFERENCE
================================================================================
Project:        AWSNBLM (Havona Anvil Suite)
Version:        v1.0
File Class:     REF
Created:        2026-02-10
Session:        023

PURPOSE:
The File Browser is a web application providing browser-based access to
the clgysing-extractions GitHub repository. It enables browsing, previewing,
and downloading files (individually or as ZIP archives) without requiring
Git, SSH, or burning Claude context on file transfers.

Primary use case: mobile/desktop access to extraction outputs and documentation
from the private repository.

================================================================================
ACCESS
================================================================================

URL:            https://mcp.justinstillness.com/files/
Authentication: HTTP Basic Auth
Username:       hafiles
Port (internal): 8095 (Flask app, behind Caddy reverse proxy)

================================================================================
ARCHITECTURE
================================================================================

STACK:
- Flask (Python) web application
- Caddy reverse proxy (SSL termination + basic auth)
- GitHub REST API (repository content access)
- systemd service management

COMPONENTS:

1. Flask App (port 8095)
   - Routes: browse directories, preview files, download files, ZIP folders
   - Communicates with GitHub API using PAT for private repo access
   - Dark theme UI, mobile-responsive

2. Caddy (reverse proxy)
   - Route: handle_path /files/* → localhost:8095
   - Basic auth via bcrypt hash (MUST use caddy hash-password to generate)
   - SSL via automatic Let's Encrypt

3. systemd Service
   - Service name: file-browser
   - Auto-restart on failure
   - Managed via: systemctl {start|stop|restart|status} file-browser

REQUEST FLOW:

User → https://mcp.justinstillness.com/files/
  → Caddy (SSL + basic auth challenge)
  → Flask app (port 8095)
  → GitHub API (fetch repo contents)
  → Response rendered to user

================================================================================
FEATURES
================================================================================

BROWSING:
- Directory listing with file names, sizes, and action buttons
- Click directory names to navigate into subdirectories
- Back button to return to parent directory
- Repository name and current path displayed

FILE OPERATIONS:
- Preview: View file contents in browser (text files)
- Download: Download individual files
- ZIP: Download entire directory as ZIP archive
- Full Repo ZIP: Download entire repository as ZIP from root view

UI CHARACTERISTICS:
- Dark theme (matches HA Suite aesthetic)
- Mobile-responsive layout
- Clean table presentation with Name, Size, Actions columns

================================================================================
CONFIGURATION
================================================================================

ENVIRONMENT/CONFIG REQUIREMENTS:
- GitHub Personal Access Token (PAT) with repo read access
- PAT stored in app configuration (not in Caddyfile)
- Target repository: justinstillness/clgysing-extractions

CADDY CONFIGURATION:

The /files/ route in the Caddyfile must use:
- handle_path (NOT handle) to strip the /files/ prefix
- basicauth block with hash generated by: caddy hash-password
- reverse_proxy to localhost:8095

CRITICAL: Always generate auth hashes using caddy hash-password command.
External bcrypt generators may produce incompatible hash formats ($2y$
vs $2a$) causing silent authentication failures (login loops).

================================================================================
MAINTENANCE
================================================================================

SERVICE MANAGEMENT:
  systemctl status file-browser     Check if running
  systemctl restart file-browser    Restart after changes
  systemctl reload caddy            Reload after Caddyfile changes
  journalctl -u file-browser -f     Tail logs

CREDENTIAL CHANGES:
1. Generate new hash: caddy hash-password --plaintext "newpassword"
2. Update Caddyfile basicauth block with new hash
3. Reload Caddy: systemctl reload caddy
4. Test: curl -u "hafiles:newpassword" https://mcp.justinstillness.com/files/

PAT ROTATION:
When GitHub PAT is rotated, update the Flask app configuration and restart
the file-browser service.

TROUBLESHOOTING:

Auth loop (credentials rejected repeatedly):
  → Most likely: bcrypt hash format mismatch
  → Fix: Regenerate hash with caddy hash-password, reload Caddy
  → Confirmed root cause and fix in S023 (D-035)

503/502 errors:
  → Check if Flask app is running: systemctl status file-browser
  → Check logs: journalctl -u file-browser --since "5 min ago"

Timeout/no response:
  → Check EC2 instance status
  → Check Caddy: systemctl status caddy
  → Check port 8095: ss -tlnp | grep 8095

================================================================================
RELATIONSHIP TO OTHER HA SUITE TOOLS
================================================================================

The File Browser is a USER-FACING tool, not an MCP connector. It does not
appear in Claude's tool inventory and is not called programmatically.

- Chronicler: Claude's programmatic access to the same repo (read/write)
- File Browser: User's browser-based access to the same repo (read-only)
- SeraphRecorder: Deposits files that File Browser can then serve
- Caliper: Analyzes files that File Browser can download

Both Chronicler and File Browser access the same GitHub repository but
serve different users (Claude vs. human) through different interfaces
(MCP API vs. web browser).

================================================================================
DEPLOYMENT HISTORY
================================================================================

Session  Date        Event
-------  ----------  ---------------------------------------------------
S022     2026-02-09  Designed and deployed via Claude Code on EC2.
                     Auth loop identified (bcrypt hash format mismatch).
S023     2026-02-10  Auth fixed by regenerating hash with caddy hash-password.
                     Full functional validation: browse, preview, download,
                     ZIP (folder and full repo), mobile confirmed.

================================================================================
END OF TOOL REFERENCE
================================================================================
